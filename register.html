
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register - SmartVote</title>
  <style>
    /* Basic reset */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #141e30, #243b55);
      overflow: hidden;
      perspective: 1200px;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
    }
    /* Background layers for subtle 3D effect */
    .background {
      position: fixed;
      top: 0;
      left: 0;
      width: 130vw;
      height: 130vh;
      pointer-events: none;
      overflow: hidden;
      z-index: -10;
    }
    .layer {
      position: absolute;
      top: 0; left: 0;
      width: 130vw;
      height: 130vh;
      background-repeat: repeat;
      background-size: cover;
      will-change: transform;
      opacity: 0.2;
      filter: brightness(0.85);
    }
    .layer-back {
      background-image: url('https://www.transparenttextures.com/patterns/black-paper.png');
      opacity: 0.35;
      z-index: -3;
    }
    .layer-mid {
      background-image: url('https://www.transparenttextures.com/patterns/dark-mosaic.png');
      opacity: 0.2;
      z-index: -2;
    }
    .layer-front {
      background-image: url('https://www.transparenttextures.com/patterns/geometry.png');
      opacity: 0.12;
      z-index: -1;
    }

    /* The main card */
    .register-card {
      background: rgba(18, 32, 47, 0.85);
      backdrop-filter: saturate(180%) blur(15px);
      padding: 45px 40px;
      border-radius: 24px;
      box-shadow: 0 30px 60px rgba(10, 100, 200, 0.45);
      width: 380px;
      text-align: center;
      animation: float 5.5s ease-in-out infinite;
      color: #d0d8e6;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0) rotateY(0deg); }
      50% { transform: translateY(-18px) rotateY(2deg); }
    }

    h2 {
      margin-bottom: 26px;
      font-weight: 700;
      letter-spacing: 1.4px;
      font-size: 2.25rem;
      color: #fff;
      text-shadow: 0 0 6px #1f9fff;
    }

    select, input {
      width: 100%;
      padding: 14px 20px;
      margin: 14px 0;
      border: none;
      border-radius: 16px;
      font-size: 1.05rem;
      background: rgba(255, 255, 255, 0.12);
      color: #f0f6ff;
      outline-offset: 2px;
      transition: background 0.35s ease, box-shadow 0.3s ease;
      box-shadow: inset 0 1px 2px rgba(255,255,255,0.15);
      font-weight: 500;
    }
    select:hover, input:hover,
    select:focus, input:focus {
      background: rgba(255, 255, 255, 0.25);
      box-shadow: 0 0 8px 3px rgba(31, 159, 255, 0.6);
    }
    ::placeholder {
      color: #cbd5e1;
      font-weight: 400;
    }

    button {
      margin-top: 22px;
      width: 100%;
      padding: 16px;
      font-weight: 700;
      font-size: 1.15rem;
      color: #e0f0ff;
      border: none;
      border-radius: 18px;
      cursor: pointer;
      background: linear-gradient(90deg, #0ea5e9, #3b82f6);
      box-shadow: 0 10px 25px rgba(14, 165, 233, 0.65);
      transition: background 0.4s ease, box-shadow 0.4s ease;
      user-select: none;
    }
    button:hover:enabled {
      background: linear-gradient(90deg, #0284c7, #2563eb);
      box-shadow: 0 14px 35px rgba(2, 132, 199, 0.8);
    }
    button:disabled {
      background: rgba(59, 130, 246, 0.4);
      cursor: not-allowed;
      box-shadow: none;
    }

    /* Google button styling */
    #googleSignInBtn {
      background: #db4437;
      margin-top: 16px;
      box-shadow: 0 10px 25px rgba(219, 68, 55, 0.65);
      font-weight: 600;
      font-size: 1.05rem;
      letter-spacing: 0.02em;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      font-family: 'Roboto', sans-serif;
    }
    #googleSignInBtn:hover:enabled {
      background: #b7372b;
      box-shadow: 0 14px 35px rgba(183, 55, 43, 0.8);
    }
    #googleSignInBtn svg {
      height: 24px;
      width: 24px;
      fill: white;
    }

    /* Message below buttons */
    #regMsg {
      margin-top: 20px;
      min-height: 24px;
      font-weight: 600;
      font-size: 1rem;
      line-height: 1.3;
    }

    /* Back link */
    a {
      display: inline-block;
      margin-top: 28px;
      font-size: 0.9rem;
      color: #7dd3fc;
      text-decoration: none;
      user-select: text;
      transition: color 0.3s ease;
    }
    a:hover, a:focus {
      color: #38bdf8;
      text-decoration: underline;
    }
  </style>
</head>
<body>

  <!-- Background layers for subtle 3D vibe -->
  <div class="background" aria-hidden="true">
    <div class="layer layer-back"></div>
    <div class="layer layer-mid"></div>
    <div class="layer layer-front"></div>
  </div>

  <!-- The registration card -->
  <main class="register-card" role="main" aria-label="Register to SmartVote">
    <h2>Sign Up</h2>

    <select id="regRole" aria-label="Select your role">
      <option value="voter">Voter</option>
      <option value="candidate">Candidate</option>
    </select>

    <input type="text" id="regUsername" placeholder="Username" aria-label="Username" autocomplete="username" required />
    <input type="password" id="regPassword" placeholder="Password" aria-label="Password" autocomplete="new-password" required />
    <input type="text" id="regPRN" placeholder="PRN Number (14 or 15 digits)" aria-label="PRN Number" required />
    <input type="text" id="regBranch" placeholder="Branch (e.g., CSE)" aria-label="Branch" required />

    <button id="registerBtn" type="button" aria-live="polite">Register</button>

    <button id="googleSignInBtn" type="button" aria-live="polite" aria-label="Register with Google">
      <svg viewBox="0 0 533.5 544.3" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
        <path d="M533.5 278.4c0-18.4-1.7-36.1-4.9-53.3H272v100.8h146.9c-6.3 34-25 62.9-53.6 82.3v68.3h86.7c50.7-46.7 79.5-115.5 79.5-198.1z" fill="#4285f4"/>
        <path d="M272 544.3c72.7 0 133.7-24.1 178.3-65.5l-86.7-68.3c-24 16-54.6 25.5-91.6 25.5-70.5 0-130.3-47.7-151.8-111.8H32.1v70.3c44.2 87.4 134.5 149.8 239.9 149.8z" fill="#34a853"/>
        <path d="M120.2 324.2c-10.5-31-10.5-64.8 0-95.8V158.1H32.1c-43.5 85.7-43.5 187.6 0 273.3l88.1-70.3z" fill="#fbbc04"/>
        <path d="M272 107.7c39.6-.6 77.7 14.4 106.6 41.3l79.8-79.8C398.7 24.6 340.6 0 272 0 166.6 0 76.3 62.4 32.1 149.8l88.1 70.3c21.5-64.2 81.3-111.8 151.8-111.8z" fill="#ea4335"/>
      </svg>
      Register with Google
    </button>

    <p id="regMsg" role="alert" aria-live="polite"></p>

    <a href="index.html" id="backToLoginLink" tabindex="0">‚Üê Back to Login</a>
  </main>

  <script type="module">
    // Import Firebase modules directly from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

    // Put your Firebase config here
    const firebaseConfig = {
      apiKey: "AIzaSyD73Q9crZ5kqVO2ziU_hp5YTyM24eQSziU",
      authDomain: "smartvote-b605e.firebaseapp.com",
      projectId: "smartvote-b605e",
      storageBucket: "smartvote-b605e.appspot.com",
      messagingSenderId: "1073958321007",
      appId: "1:1073958321007:web:cfb8c80143746382f6c69a"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    const registerBtn = document.getElementById('registerBtn');
    const googleBtn = document.getElementById('googleSignInBtn');
    const regMsg = document.getElementById('regMsg');

    // Show message helper
    function showMessage(msg, isError = false) {
      regMsg.textContent = msg;
      regMsg.style.color = isError ? '#ff6b6b' : '#7ee787';
    }

    // Simple validation
    function validateForm({ username, password, prn, branch }) {
      if (!username.trim() || !password || !prn.trim() || !branch.trim()) {
        showMessage('All fields are required!', true);
        return false;
      }
      if (prn.length !== 14 && prn.length !== 15) {
        showMessage('PRN number must be 14 or 15 digits.', true);
        return false;
      }
      if (password.length < 6) {
        showMessage('Password should be at least 6 characters.', true);
        return false;
      }
      return true;
    }

    registerBtn.addEventListener('click', async () => {
      registerBtn.disabled = true;
      showMessage('Registering...');

      const role = document.getElementById('regRole').value;
      const username = document.getElementById('regUsername').value;
      const password = document.getElementById('regPassword').value;
      const prn = document.getElementById('regPRN').value;
      const branch = document.getElementById('regBranch').value;

      if (!validateForm({ username, password, prn, branch })) {
        registerBtn.disabled = false;
        return;
      }

      try {
        // Check if user already exists in Firestore by username
        const userDocRef = doc(db, 'users', username);
        const userDocSnap = await getDoc(userDocRef);
        if (userDocSnap.exists()) {
          showMessage('Username already taken, try another.', true);
          registerBtn.disabled = false;
          return;
        }

        // Create Firebase Auth user
        const userCredential = await createUserWithEmailAndPassword(auth, `${username}@smartvote.com`, password);

        // Save extra info in Firestore
        await setDoc(doc(db, 'users', username), {
          role,
          prn,
          branch,
          email: userCredential.user.email,
          uid: userCredential.user.uid,
          createdAt: new Date().toISOString()
        });

        showMessage('Registration successful! You can now login.');
        // Optionally, redirect to login after a short pause:
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 2000);

      } catch (err) {
        console.error('Registration error:', err);
        showMessage('Oops! Something went wrong: ' + err.message, true);
        registerBtn.disabled = false;
      }
    });

    googleBtn.addEventListener('click', async () => {
      googleBtn.disabled = true;
      showMessage('Signing in with Google...');

      const provider = new GoogleAuthProvider();

      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        // Check if user exists in Firestore
        const userDocRef = doc(db, 'users', user.email.split('@')[0]);
        const userDocSnap = await getDoc(userDocRef);

        if (!userDocSnap.exists()) {
          // First time Google sign-up: create user record with default role voter
          await setDoc(userDocRef, {
            role: 'voter',
            email: user.email,
            uid: user.uid,
            createdAt: new Date().toISOString()
          });
        }

        showMessage('Google sign-in successful! Redirecting...');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1500);

      } catch (err) {
        console.error('Google sign-in error:', err);
        showMessage('Google sign-in failed: ' + err.message, true);
        googleBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
